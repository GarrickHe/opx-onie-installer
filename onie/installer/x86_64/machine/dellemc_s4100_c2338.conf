# Machine specific configuration for Dell EMC S4100 C2338 processor
# The S4100 series has multiple NPU configurations, but identical CPU
# configuration across all the SKUs

# Set a few GRUB_xxx environment variables that will be picked up and
# used by the 50_onie_grub script.  This is similiar to what an OS
# would specify in /etc/default/grub.
#
# GRUB_SERIAL_COMMAND
# GRUB_CMDLINE_LINUX
export GRUB_SERIAL_COMMAND="serial --port=0x3f8 --speed=115200 --word=8 --parity=no --stop=1"
export GRUB_CMDLINE_LINUX="console=ttyS0,115200"

# Use USB interface for the serial IO, console defaults to the RJ45 serial port
OS10_SERIAL_COMMAND="serial --unit=1 --speed=115200 --word=8 --parity=no --stop=1"
GRUB_TERMINAL_IO="serial console"

# Compute the flavor based on the hardware revision
# Arg1: Major flavor (S4148F/S4148T/S4148E)
os10_s4100x_machine_rev()
{
    # Read the machine revision (Label Revision field in EEPROM)
    local machine_rev=$(onie-syseeprom -g 0x27)
    case "$machine_rev" in
    "X00")
        echo "$1-x00"
        ;;

    *)
        # Treat all other values as if this is an X01 box
        echo "$1"
        ;;
    esac
}

# The variant is based upon the Product Name stored in EEPROM
OS10_MACHINE_VARIANT=$(onie-syseeprom -g 0x21)

# We must have a valid platform name saved in the EEPROM
# Validate the flavor is one of the supported versions
case "$OS10_MACHINE_VARIANT" in
    "S4148-ON" | "S4148F-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=$(os10_s4100x_machine_rev s4148f)
        OS10_PLATFORM_DISPLAY_NAME="S4148F-ON"
        ;;

    "S4148T-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=$(os10_s4100x_machine_rev s4148t)
        OS10_PLATFORM_DISPLAY_NAME="$OS10_MACHINE_VARIANT"
        ;;

    "S4148E-ON" | "S4148FE-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=$(os10_s4100x_machine_rev s4148e)
        OS10_PLATFORM_DISPLAY_NAME="S4148FE-ON"
        ;;

    "S4148U-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=s4148u
        OS10_PLATFORM_DISPLAY_NAME="$OS10_MACHINE_VARIANT"
        ;;

    "S4128-ON" | "S4128F-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=s4128f
        OS10_PLATFORM_DISPLAY_NAME="S4128F-ON"
        ;;

    "S4128T-ON")
        # Display name in os10-show-version
        OS10_VM_FLAVOR=$(os10_s4100x_machine_rev s4128t)
        OS10_PLATFORM_DISPLAY_NAME="$OS10_MACHINE_VARIANT"
        ;;

    "S4112F-ON")
        # Display name in os10-show-version
        OS10_PLATFORM_DISPLAY_NAME="$OS10_MACHINE_VARIANT"
        OS10_VM_FLAVOR=s4112f
        ;;

    "S4112T-ON")
        # Display name in os10-show-version
        OS10_PLATFORM_DISPLAY_NAME="$OS10_MACHINE_VARIANT"
        OS10_VM_FLAVOR=s4112t
        ;;

    *)
        error "Unsupported S4100 variant: '$OS10_MACHINE_VARIANT'"
        error "Check EEPROM contents"
        abort 1
        ;;
esac

# If ONIE has been upgraded, then the machine name will reflect the current
# SKU, however, the blueprint only recognizes the older "family" name.
# Reset the machine name to match the blueprint
export OS10_MACHINE='dellemc_s4100_c2338'

export OS10_VM_FLAVOR
export OS10_PLATFORM_DISPLAY_NAME

